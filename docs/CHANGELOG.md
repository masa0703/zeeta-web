# 変更履歴 (CHANGELOG)

このファイルは完了した作業の履歴を記録します。新しいエントリは上部に追加されます。

---

## 2026-02-07 (7)

### 実装内容
- **S100 ドラッグ&ドロップ安定化**:
  - ツリースコープのposition更新APIを追加
    - `PATCH /api/trees/:id/relations/:parent/:child/position`
    - `PATCH /api/trees/:id/nodes/:id/root-position`
  - SortableJS設定を改善
    - swapThreshold: 0.65 → 0.5（より正確な配置）
    - invertSwap: true（より自然なスワップ動作）
    - delay: 50ms（誤操作防止）
  - 異なる親への移動に対応（関係の削除・追加を自動処理）
  - 視覚的フィードバック改善
    - ghostClass, chosenClass, dragClass でドラッグ中のスタイル強化
    - ドロップ可能エリアの明示
  - ツリー最後へのドロップを可能に
    - tree-containerに下部パディング追加
    - 「ルートの最後にドロップ」ガイド表示

### 修正ファイル
- `src/index.tsx` - position更新APIを追加、CSSスタイル追加
- `public/static/app.js` - reorderNodes関数をツリースコープAPIに対応、handleParentChange関数追加

---

## 2026-02-07 (6)

### 実装内容
- **S100 閲覧者権限でのボタン無効化**:
  - 閲覧権限ユーザーの場合、削除・保存ボタンをdisabled状態に
  - タイトル入力・作成者選択もdisabled状態に
  - 親ノード削除ボタンもdisabled状態に
  - スタイル: opacity 0.5、cursor not-allowed

### 修正ファイル
- `public/static/app.js` - renderEditor関数でviewer権限チェックを追加

---

## 2026-02-07 (5)

### 実装内容
- **S100 ボタンツールチップを英語に変更**:
  - 削除ボタン: "delete node"
  - 保存ボタン: "save node (cmd+enter)" / "save node (ctrl+enter)"

### 修正ファイル
- `public/static/app.js` - ボタンのtitle属性を英語に変更

---

## 2026-02-07 (4)

### 実装内容
- **更新日タイムゾーン修正の完了**: formatDate関数のバグを修正
  - コメント構文エラー（`/` → `//`）を修正
  - ロジックを簡素化し、すべての日付形式でZサフィックスを適切に追加
  - E2Eテストを作成して動作を検証

### 修正ファイル
- `public/static/app.js` - formatDate関数を修正

### テスト結果
- **成功**: 4/4 (100%)
- **テストファイル**: `tests/format-date.spec.js`
- テスト内容:
  - SQLite形式 `2026-02-07 01:48:00` → `2026/02/07 10:48` (JST)
  - ISO形式 `2026-02-07T01:48:00` → `2026/02/07 10:48` (JST)
  - Z付きISO形式 `2026-02-07T01:48:00Z` → `2026/02/07 10:48` (JST)
  - 実際のノード保存後の表示確認

---

## 2026-02-07 (3)

### 実装内容
- **S010 招待取り消し機能**: 招待中のユーザーを取り消し可能に
  - バックエンド: `DELETE /api/trees/:id/invitations/:invitationId` APIを追加
  - フロントエンド: 招待リストに取り消しボタン（×）を追加
  - 確認ダイアログ表示後に実行
- **S100 親ノードアコーディオン**: 親ノード表示を折りたたみ式に変更
  - デフォルトは閉じた状態
  - クリックで展開/折りたたみ
  - アイコン（▼/▲）で状態表示
- **S100 左マージン調整**: 「← マイページ」リンクに左マージン4pxを追加
- **S100 右ペインレイアウト変更**:
  - 「ノード詳細」ヘッダーを削除
  - タイトル入力を固定ヘッダー領域に移動
  - 削除・保存ボタンをアイコンのみに変更（テキスト削除）
  - タイトル入力エリアを広く確保
- **S100 内容エリアリサイズ**: EasyMDEエディタをリサイズ可能に
  - 最小高さ200px、最大高さ600px
  - ユーザーが高さを調整可能
- **S100 更新日タイムゾーン修正**: 作成日・更新日をローカルタイムゾーンで表示
  - SQLiteのUTC時刻をローカル時刻に変換して表示

### 修正ファイル
- `src/index.tsx` - 招待取り消しAPIを追加、cancelInvitationをインポート
- `public/static/my-page.js` - 招待取り消しUI・ロジックを追加
- `public/static/app.js` - アコーディオン、レイアウト変更、リサイズ機能を追加
- `docs/architecture/screen-definition.md` - S010/S100の仕様を更新

---

## 2026-02-07 (2)

### 実装内容
- **S030 GitHubログイン非表示**: ログインページからGitHubボタンを削除（バックエンドは維持）
- **S010注意書きバナー更新**: マイページの注意書き文言を変更
  - データプライバシーと継続性についての注意
  - 親ノード追加の操作手順を記載
- **S100右クリックメニュー**: ノード右クリックでコンテキストメニューを表示
  - 「複製」: 現在パスの親ノード下に「Copy of {タイトル}」で複製
  - 「コピー (⌘C)」: ノードをクリップボードにコピー
  - 「ペースト (⌘V)」: コピーしたノードを親子関係として追加
- **画面定義書更新**: screen-definition.md を最新の実装に同期

### 修正ファイル
- `public/login.html` - GitHubログインボタンを削除
- `public/my-page.html` - 注意書きバナーの文言を変更
- `public/static/app.js` - 右クリックコンテキストメニュー追加、duplicateNode関数追加
- `docs/architecture/screen-definition.md` - S030/S010/S100の仕様を更新

---

## 2026-02-07

### 実装内容
- **S100未保存確認機能**: 編集後、保存せずに他のノードを選択しようとすると「変更内容を保存しますか？」確認ダイアログを表示
  - 「はい」で保存してからノード切り替え
  - 「いいえ」で変更を破棄してノード切り替え
  - 矢印キーでのナビゲーション時も同様に動作
- **S010ツリー名編集ダイアログ**: ネイティブpromptからカスタムモーダルに変更
- **S010空状態改善**: 「まだツリーがありません」のフォルダアイコンを削除
- **S010ヘッダー固定**: スクロール時もヘッダーが固定表示されるように変更
- **S100ノードタイトル省略**: 長いタイトルは「…」で省略、マウスオーバーで全文表示
- **S100リロードボタン**: ツリー名+ロールの右側に回転アイコンのリロードボタンを追加
- **S010ツリー削除機能**: ゴミ箱アイコンで論理削除（is_deletedフラグ）

### 修正ファイル
- `public/static/app.js` - 未保存確認機能、ノードタイトル省略、リロードボタン追加
- `public/my-page.html` - ヘッダー固定、編集/削除モーダル追加
- `public/static/my-page.js` - カスタムダイアログ、削除機能、フォルダアイコン削除
- `src/utils/trees.ts` - 論理削除対応（is_deletedフィルタリング）
- `migrations/0007_add_trees_deleted_flag.sql` - 新規マイグレーション

### 注意
- **本番デプロイ時**: マイグレーション `0007_add_trees_deleted_flag.sql` を実行すること

---

## 2026-02-06 (2)

### 実装内容
- **ツリー名編集機能**: マイページのツリーカードから直接ツリー名を変更可能に
- **ツリービュー改善**: ノードの上下パディングを2pxに変更（よりコンパクトな表示）
- **S100エディタ画面簡素化**: ヘッダーから通知アイコン、ユーザー名、ログアウトボタン、「Zeeta Web」ロゴ、ビルド番号を削除
- **S100ルート追加ボタン移動**: 「＋ルート追加」ボタンをタブ（通常/逆ツリー）と同じ行に配置
- **S010マイページ改善**: ヘッダーにビルド番号バッジを追加
- **S010ツリーカード改善**: オーナー用の鉛筆アイコン（編集ボタン）を追加

### 修正ファイル
- `public/static/app.js` - ツリービューパディング変更、エディタヘッダー簡素化
- `src/index.tsx` - エディタサイドバーのレイアウト変更（タブとルート追加ボタンを同一行に）
- `public/my-page.html` - ヘッダーにビルド番号バッジ追加
- `public/static/my-page.js` - fetchVersion関数、editTreeName関数、ツリーカード編集ボタン追加

---

## 2026-02-06

### 実装内容
- **招待フロー改善**: OAuth認証後に招待受諾ページへ自動リダイレクト
- **作成者フィールド**: テキスト入力からドロップダウン選択に変更（編集権限者のみ表示）
- **デフォルト作成者**: ノード新規作成時にログインユーザーを自動設定
- **保存ショートカット**: Cmd/Ctrl + Enter で保存可能、ツールチップ表示
- **UI改善**: タイトル入力欄のフォントサイズ拡大
- **注意書きバナー**: S010マイページに利用上の注意を追加
- **ドキュメント整理**: docs/フォルダをarchitecture/guides/testing/に再構成
- **画面定義書更新**: ID体系（S010〜S100）を導入、全画面の仕様を最新化

### 修正ファイル
- `src/index.tsx` - OAuth リダイレクトパラメータ対応
- `public/login.html` - リダイレクトURL処理
- `public/static/app.js` - 作成者ドロップダウン、ショートカット、UI改善
- `public/my-page.html` - 注意書きバナー追加
- `docs/architecture/screen-definition.md` - 画面定義書を全面更新

### テスト結果
- **成功**: 8/8 (100%)
- **テストファイル**: `tests/todo-2026-02-06.spec.js`
- **詳細レポート**: [testing/reports/2026-02-06.md](testing/reports/2026-02-06.md)

---

## 2026-01-30

### 実装内容
- **Phase 13 完了**: 最終統合テスト・ポリッシュ
- **メールサービス移行**: Resend → SendGrid → Mailgun

### テスト結果
- **成功**: 15/16 (93.75%)
- **スキップ**: TC-PERF-002（メール送信制限）
- **詳細**: [testing/test-plan-phase13.md](testing/test-plan-phase13.md)

---

## 2026-01-29

### 実装内容
- **Phase 10-11 完了**: プロフィール管理、通知システム
- マルチユーザー対応全13フェーズ完了

### テスト結果
- **累計**: 76/77 成功 (98.7%)

---

## 2026-01-28

### 実装内容
- **Phase 7-8 完了**: 招待システム、招待テスト
- 招待メール送信機能
- 招待受諾ページUI

---

## 2026-01-27

### 実装内容
- **Phase 4-6 完了**: E2Eテスト、楽観的ロック
- メンバー管理API
- 競合解決UI

---

## 2026-01-26

### 実装内容
- **Phase 1-3 完了**: 基盤、ツリー管理、ノード管理
- マルチユーザー対応開始
- OAuth認証（Google/GitHub）
- JWTセッション管理
- ツリー・権限管理システム
