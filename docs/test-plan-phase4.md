# Phase 4 E2Eテスト計画

## テスト対象範囲

Phase 1-3 で実装した以下の機能に対する E2E テスト:
- Phase 1: 認証システム（OAuth、JWT、セッション管理）
- Phase 2: ツリー管理、権限システム、メンバー管理
- Phase 3: ツリースコープノード管理、権限ベースUI

## テスト環境

- **テストフレームワーク**: Playwright
- **ブラウザ**: Chromium, Firefox, WebKit
- **データベース**: ローカルD1（テスト用）
- **認証**: モック OAuth プロバイダー（開発中は実際の OAuth をスキップ可能にする）

## 1. 認証フローテスト

### TC-AUTH-001: 未認証ユーザーのリダイレクト
**目的**: 未認証ユーザーがログインページにリダイレクトされることを確認
**前提条件**: ログアウト状態
**テスト手順**:
1. `/my-page.html` にアクセス
2. `/login.html` にリダイレクトされることを確認

**期待結果**:
- ログインページが表示される
- URL が `/login.html` である

---

### TC-AUTH-002: ログイン後のリダイレクト
**目的**: ログイン後にマイページにリダイレクトされることを確認
**前提条件**: ログアウト状態
**テスト手順**:
1. `/login.html` にアクセス
2. Google でログイン（モック）
3. `/my-page.html` にリダイレクトされることを確認

**期待結果**:
- マイページが表示される
- ユーザー情報が表示される

---

### TC-AUTH-003: セッション永続性
**目的**: ページリロード後もセッションが維持されることを確認
**前提条件**: ログイン済み
**テスト手順**:
1. マイページにアクセス
2. ページをリロード
3. ログイン状態が維持されることを確認

**期待結果**:
- リロード後もログイン状態が保持される
- 再度ログインを求められない

---

### TC-AUTH-004: ログアウト機能
**目的**: ログアウトが正常に機能することを確認
**前提条件**: ログイン済み
**テスト手順**:
1. マイページのログアウトボタンをクリック
2. `/login.html` にリダイレクトされることを確認
3. マイページに直接アクセスを試みる
4. ログインページにリダイレクトされることを確認

**期待結果**:
- ログアウト後はログインページに遷移
- セッションがクリアされる
- 保護されたページにアクセスできない

---

## 2. ツリー管理テスト

### TC-TREE-001: ツリー作成
**目的**: 新しいツリーを作成できることを確認
**前提条件**: ログイン済み、マイページ表示中
**テスト手順**:
1. 「新しいツリーを作成」ボタンをクリック
2. ツリー名「テストプロジェクト」を入力
3. 説明「テスト用のプロジェクトです」を入力
4. 「作成」ボタンをクリック

**期待結果**:
- ツリーが作成される
- マイツリーセクションに新しいツリーが表示される
- ツリーカードに「オーナー」バッジが表示される

---

### TC-TREE-002: ツリー一覧表示
**目的**: 自分のツリーと共有されたツリーが正しく表示されることを確認
**前提条件**: ログイン済み、複数のツリーが存在（所有 + 共有）
**テスト手順**:
1. マイページにアクセス
2. 「マイツリー」セクションを確認
3. 「共有されたツリー」セクションを確認

**期待結果**:
- 所有しているツリーが「マイツリー」に表示される
- 共有されているツリーが「共有されたツリー」に表示される
- 各ツリーに適切な役割バッジが表示される

---

### TC-TREE-003: ツリーへのアクセス
**目的**: ツリーをクリックしてエディタに遷移できることを確認
**前提条件**: ログイン済み、ツリーが1つ以上存在
**テスト手順**:
1. マイページでツリーカードをクリック
2. エディタページに遷移することを確認

**期待結果**:
- エディタページが表示される
- URLに `?tree=<tree_id>` パラメータが含まれる
- ツリーヘッダーにツリー名と役割が表示される

---

### TC-TREE-004: ツリー削除（オーナーのみ）
**目的**: オーナーのみがツリーを削除できることを確認
**前提条件**: ログイン済み、オーナーのツリーが存在
**テスト手順**:
1. マイページでツリーを選択
2. 削除ボタンをクリック（実装が必要な場合はAPI直接テスト）
3. 確認ダイアログで「OK」

**期待結果**:
- ツリーが削除される
- ツリー一覧から消える
- 削除されたツリーにアクセスできない

---

## 3. ノード操作テスト

### TC-NODE-001: ノード作成
**目的**: ツリー内でノードを作成できることを確認
**前提条件**: ログイン済み、編集者またはオーナー権限、エディタ表示中
**テスト手順**:
1. エディタで「ルートノード追加」ボタンをクリック
2. タイトル「テストノード」を入力
3. 内容「テスト内容」を入力
4. 作成者名を入力

**期待結果**:
- ノードが作成される
- ツリービューに新しいノードが表示される
- ノードを選択すると詳細が表示される

---

### TC-NODE-002: ノード編集
**目的**: ノードの内容を編集できることを確認
**前提条件**: ログイン済み、編集者またはオーナー権限、ノードが存在
**テスト手順**:
1. ノードを選択
2. タイトルを「更新されたタイトル」に変更
3. 内容を「更新された内容」に変更
4. 保存

**期待結果**:
- ノードが更新される
- ツリービューのタイトルが更新される
- 再選択時に更新内容が表示される

---

### TC-NODE-003: ノード削除
**目的**: ノードを削除できることを確認
**前提条件**: ログイン済み、編集者またはオーナー権限、ノードが存在
**テスト手順**:
1. ノードを選択
2. 削除ボタンをクリック
3. 確認ダイアログで「OK」

**期待結果**:
- ノードが削除される
- ツリービューから消える
- 選択状態がクリアされる

---

### TC-NODE-004: 親子関係の追加
**目的**: ノード間に親子関係を作成できることを確認
**前提条件**: ログイン済み、編集者またはオーナー権限、2つ以上のノードが存在
**テスト手順**:
1. 親ノードを選択
2. 「子ノードを追加」機能を使用
3. 既存ノードから選択

**期待結果**:
- 親子関係が作成される
- 子ノードが親ノードの下に表示される
- 親ノードを展開すると子ノードが表示される

---

### TC-NODE-005: 親子関係の削除
**目的**: 親子関係を削除できることを確認
**前提条件**: ログイン済み、編集者またはオーナー権限、親子関係が存在
**テスト手順**:
1. 親子関係を持つノードを確認
2. 関係削除ボタンをクリック
3. 確認

**期待結果**:
- 親子関係が削除される
- 子ノードは削除されずにルートレベルに移動

---

## 4. 権限テスト

### TC-PERM-001: オーナー権限
**目的**: オーナーが全ての操作を実行できることを確認
**前提条件**: ログイン済み、オーナー権限のツリー
**テスト手順**:
1. ツリーにアクセス
2. ノードの作成・編集・削除を実行
3. メンバー管理ボタンが表示されることを確認

**期待結果**:
- 全ての編集操作が可能
- メンバー管理機能にアクセス可能
- ツリー設定変更が可能

---

### TC-PERM-002: 編集者権限
**目的**: 編集者がノード編集とメンバー招待ができることを確認
**前提条件**: ログイン済み、編集者権限のツリー
**テスト手順**:
1. ツリーにアクセス
2. ノードの作成・編集・削除を実行
3. メンバー管理ボタンが表示されることを確認
4. ツリー設定変更を試みる

**期待結果**:
- ノードの編集操作が可能
- メンバー招待が可能
- ツリー設定変更は不可

---

### TC-PERM-003: 閲覧者権限（読み取り専用）
**目的**: 閲覧者が編集できないことを確認
**前提条件**: ログイン済み、閲覧者権限のツリー
**テスト手順**:
1. ツリーにアクセス
2. ヘッダーに「閲覧専用」表示を確認
3. 入力フィールドが無効化されていることを確認
4. 編集ボタンが無効化されていることを確認

**期待結果**:
- 「閲覧専用モード」の通知が表示される
- 全ての入力フィールドが読み取り専用
- 編集ボタンが無効化またはエラー
- ノードの閲覧は可能

---

### TC-PERM-004: 閲覧者の編集試行（APIレベル）
**目的**: 閲覧者がAPI経由で編集を試みても拒否されることを確認
**前提条件**: ログイン済み、閲覧者権限のツリー
**テスト手順**:
1. ブラウザのコンソールからAPI直接呼び出し
2. ノード作成APIを呼び出し
3. 403 Forbidden エラーが返されることを確認

**期待結果**:
- API呼び出しが 403 エラーで拒否される
- エラーメッセージ「You do not have permission to edit this tree」

---

## 5. ツリー分離テスト

### TC-ISOL-001: 別ツリーのノードへのアクセス拒否
**目的**: 異なるツリーのノードに不正アクセスできないことを確認
**前提条件**: ログイン済み、2つのツリーが存在
**テスト手順**:
1. ツリーAにアクセス
2. URLを手動で変更してツリーBのノードIDを指定
3. アクセスが拒否されることを確認

**期待結果**:
- アクセスが拒否される
- エラーメッセージが表示される
- ツリーAのコンテキストが維持される

---

### TC-ISOL-002: 別ツリーへの親子関係作成の拒否
**目的**: 異なるツリー間で親子関係を作成できないことを確認
**前提条件**: ログイン済み、2つのツリーにそれぞれノードが存在
**テスト手順**:
1. API経由でツリーA のノードとツリーB のノード間に親子関係を作成試行
2. エラーが返されることを確認

**期待結果**:
- 400 Bad Request エラー
- エラーメッセージ「Both nodes must belong to the same tree」

---

### TC-ISOL-003: アクセス権のないツリーへのアクセス拒否
**目的**: メンバーでないツリーにアクセスできないことを確認
**前提条件**: ログイン済み、他のユーザーのツリーが存在
**テスト手順**:
1. 他のユーザーのツリーIDを使ってエディタにアクセス試行
2. アクセスが拒否されることを確認

**期待結果**:
- 403 Forbidden エラー
- マイページにリダイレクト
- エラー通知「このツリーへのアクセス権がありません」

---

## テスト実行順序

1. **認証フローテスト** (TC-AUTH-001 ~ TC-AUTH-004)
   - システムの基盤となる認証機能を最初に検証

2. **ツリー管理テスト** (TC-TREE-001 ~ TC-TREE-004)
   - ツリーの作成・表示・アクセスを検証

3. **ノード操作テスト** (TC-NODE-001 ~ TC-NODE-005)
   - ツリー内でのノード操作を検証

4. **権限テスト** (TC-PERM-001 ~ TC-PERM-004)
   - 役割ベースのアクセス制御を検証

5. **ツリー分離テスト** (TC-ISOL-001 ~ TC-ISOL-003)
   - ツリー間の分離を検証

## テスト環境セットアップ

### 必要な準備
1. ローカル開発サーバー起動 (`npm run dev`)
2. テスト用データベースの初期化
3. テスト用ユーザーアカウントの作成（モック認証）
4. Playwright のインストールとブラウザセットアップ

### モック認証の実装
OAuth 認証をスキップして、テスト用のユーザーでログインできる仕組みを実装:
- `GET /auth/test-login?user_id=1` - テスト用ログインエンドポイント
- 開発環境でのみ有効

## 成功基準

- **全テストケースが Pass**: 18個のテストケース全てが成功
- **クロスブラウザ対応**: Chromium, Firefox, WebKit で動作
- **実行時間**: 全テスト 5分以内
- **カバレッジ**: Phase 1-3 の主要機能を80%以上カバー

## テスト成果物

1. **テストコード**: `tests/multi-user-phase4.spec.js`
2. **テストレポート**: HTML レポート（Playwright Reporter）
3. **スクリーンショット**: 失敗時の画面キャプチャ
4. **バグレポート**: 発見されたバグのリスト

## 注意事項

- OAuth 認証は実際のGoogle/GitHub を使わず、テスト用のモック認証を使用
- テスト間でデータベースをクリーンアップ
- テストは独立して実行可能であること（順序依存しない）
- CI/CD パイプラインでの自動実行を想定
