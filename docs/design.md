# アウトラインエディタ設計書

## プロジェクト概要

このプロジェクトは、階層的なツリー構造でアイデアやプロジェクトを管理できるWebベースのアウトラインエディタです。HonoフレームワークとCloudflare D1データベースを使用して構築されています。

### 主な機能
- ツリー構造でのノード管理（左ペイン）
- ノード詳細編集（右ペイン）
- ノードの作成・編集・削除
- 階層構造の展開/折りたたみ
- 子ノードの追加
- ドラッグ&ドロップ並び替え
- 親子関係の変更（循環参照チェック付き）
- リアルタイム検索機能

## アーキテクチャ

### 全体構成
- **フロントエンド**: Vanilla JavaScript + HTML/CSS
- **バックエンド**: Hono (TypeScript) on Cloudflare Workers
- **データベース**: Cloudflare D1 (SQLite)
- **デプロイ**: Cloudflare Pages

### データフロー
1. フロントエンド（Vanilla JS）→ Axios で API リクエスト
2. バックエンド（Hono）→ Cloudflare D1 でデータ取得/更新
3. レスポンス JSON → フロントエンドでツリー表示

## データモデル

### nodes テーブル
```sql
- id: INTEGER (主キー, 自動採番)
- parent_id: INTEGER (親ノードのID、NULL = ルートノード) ※ 非推奨、node_relations使用
- title: TEXT (ノードのタイトル)
- content: TEXT (ノードの内容)
- author: TEXT (作成者名)
- created_at: DATETIME (作成日時)
- updated_at: DATETIME (更新日時)
- position: INTEGER (表示順序) ※ 非推奨、node_relations使用
- root_position: INTEGER (ルートノードの表示順序)
```

### node_relations テーブル
```sql
- parent_node_id: INTEGER (親ノードID)
- child_node_id: INTEGER (子ノードID)
- position: INTEGER (同一親内での順序)
```

## API仕様

### エンドポイント一覧

| メソッド | パス                                           | 説明                 |
| -------- | ---------------------------------------------- | -------------------- |
| GET      | `/api/version`                                 | バージョン情報取得   |
| GET      | `/api/nodes`                                   | 全ノード取得         |
| GET      | `/api/nodes/:id`                               | 特定ノード取得       |
| GET      | `/api/nodes/:id/children`                      | 子ノード取得         |
| GET      | `/api/nodes/:id/parents`                       | 親ノード取得         |
| GET      | `/api/nodes/root/list`                         | ルートノード取得     |
| GET      | `/api/relations`                               | 全リレーション取得   |
| POST     | `/api/nodes`                                   | ノード作成           |
| PUT      | `/api/nodes/:id`                               | ノード更新           |
| DELETE   | `/api/nodes/:id`                               | ノード削除           |
| POST     | `/api/relations`                               | 親子関係追加         |
| DELETE   | `/api/relations/:parent_id/:child_id`          | 親子関係削除         |
| PATCH    | `/api/relations/:parent_id/:child_id/position` | リレーション位置更新 |
| PATCH    | `/api/nodes/:id/root-position`                 | ルート位置更新       |
| GET      | `/api/search?q=検索語`                         | 検索                 |
| DELETE   | `/api/test/clear`                              | テスト用全データクリア |

### 主要API詳細

#### ノード作成 (POST /api/nodes)
- リクエストボディ: `{title, content?, author, root_position?}`
- 必須フィールド: title, author
- root_position未指定時は自動計算

#### ノード更新 (PUT /api/nodes/:id)
- リクエストボディ: `{title?, content?, author?}`
- 部分更新可能

#### 親子関係追加 (POST /api/relations)
- リクエストボディ: `{parent_node_id, child_node_id}`
- 循環参照チェックを実施
- 位置は自動計算（親の最後に追加）

#### テスト用全データクリア (DELETE /api/test/clear)
- テスト実行時にデータベースをクリーンな状態にリセット
- `node_relations`テーブルと`nodes`テーブルの全データを削除
- `sqlite_sequence`のauto_incrementカウンターをリセット
- レスポンス: `{success: true, message: 'All data cleared'}`
- **注意**: 本番環境では使用禁止（テスト専用）

## フロントエンド構造

### 主要コンポーネント
- **ツリー表示部**: 左ペイン、階層構造を表示
- **詳細編集部**: 右ペイン、選択ノードの編集
- **検索バー**: リアルタイム検索機能
- **ツールバー**: 各種操作ボタン

### 状態管理
- `nodes`: 全ノードデータ
- `relations`: 親子関係データ
- `selectedNodeId`: 現在選択中のノードID
- `expandedNodes`: 展開されているノードのセット
- `searchQuery`: 検索クエリ
- `searchResults`: 検索結果

### 主な関数
- `renderTree()`: ツリーの再描画
- `selectNode(id)`: ノード選択
- `createNode(parentId)`: ノード作成
- `updateNode(id, data)`: ノード更新
- `deleteNode(id)`: ノード削除
- `moveNode(childId, newParentId, position)`: ノード移動
- `performSearch(query)`: 検索実行

## ビルド・デプロイ

### ビルドツール
- **Vite**: 開発サーバーとビルド
- **Wrangler**: Cloudflare Workers/Pages デプロイ

### 主要スクリプト
- `npm run dev`: 開発サーバー起動
- `npm run build`: プロダクションビルド
- `npm run deploy:prod`: Cloudflare Pages デプロイ

### データベース操作
- `npm run db:migrate:local`: ローカルDBマイグレーション
- `npm run db:migrate:prod`: 本番DBマイグレーション
- `npm run db:seed`: シードデータ投入

## 技術スタック

### フロントエンド
- Vanilla JavaScript
- Tailwind CSS (CDN)
- Font Awesome (CDN)
- Axios (CDN)
- SortableJS (ドラッグ&ドロップ)

### バックエンド
- Hono v4 (軽量Webフレームワーク)
- TypeScript
- Cloudflare Workers

### データベース
- Cloudflare D1 (SQLiteベース)

### 開発ツール
- Vite
- Wrangler
- PM2 (開発サーバー管理)

## セキュリティ・考慮事項

### 循環参照防止
- 親子関係追加時に循環参照チェックを実施
- 祖先ノードを再帰的に探索

### 入力検証
- APIレベルでの必須フィールドチェック
- 自己参照防止

### エラーハンドリング
- 統一されたエラーレスポンス形式
- フロントエンドでのトースト通知

## キーボードショートカット

### コピー&ペースト機能
- **Ctrl+C (Mac: Cmd+C)**: 選択中のノードをクリップボードにコピー
- **Ctrl+V (Mac: Cmd+V)**: クリップボードのノードを選択中のノードの子として追加

#### 動作仕様
1. ノードをコピー（Ctrl+C）
   - 現在選択中のノードのIDをクリップボードに保存
   - トースト通知「ノードをコピーしました」を表示
   - エディタ内（input/textarea）でのテキスト選択時は動作しない

2. ノードをペースト（Ctrl+V）
   - クリップボードのノードを、現在選択中のノードの子として親子関係を追加
   - 循環参照チェックを実施
   - 既存の親子関係がある場合はエラー
   - 成功時は親ノードを展開して表示
   - トースト通知「親子関係を追加しました」を表示
   - エディタ内（input/textarea）でのテキスト選択時は動作しない

#### エラーケース
- 循環参照が検出された場合: 「循環参照です。この操作はできません。」
- 既存の親子関係がある場合: 「この親子関係はすでに存在します」
- 自己参照の場合: 「自己参照はできません」

## 右ペイン（ノード詳細）

### 親ノード表示機能
選択中のノードの親ノードを右ペインに表示します。

#### 表示仕様
1. **ルートノード**（親を持たないノード）
   - 親ノード表示エリアは非表示

2. **非ルートノード**（1つ以上の親を持つノード）
   - 親ノード表示エリアを表示（紫色の背景: `bg-purple-50 border-purple-200`）
   - ヘッダー: 「親ノード (N)」（Nは親の数）
   - 親ノードリストを白背景のカードで表示
   - 各カードに親タイトルと削除ボタン（×）を表示

#### UI実装詳細
- **親ノードセクション**
  - クラス: `bg-purple-50 border border-purple-200 rounded`
  - アイコン: `fas fa-sitemap`
  - 親の数を表示: 「親ノード (2)」

- **親ノードカード**
  - 各親を白背景カード（`bg-white`）で表示
  - 親タイトル（紫色テキスト: `text-purple-700`）
  - 削除ボタン（クラス: `.remove-parent-btn`, `data-parent-id`属性に親ID）
  - 削除ボタンアイコン: `fas fa-times`（赤色）

#### 親削除機能
- 削除ボタン（×）クリックで確認ダイアログを表示
- 確認後、該当の親子関係を削除（`DELETE /api/relations/:parent_id/:child_id`）
- 削除後、ノードを再選択して表示を更新
- **最後の親を削除した場合**
  - ノードはルートノードになる
  - 親ノード表示エリアが非表示になる
  - ツリー表示が更新され、ルートレベルに表示される

## テストケース

### 機能テスト

#### TC-FUNC-001: ノード追加機能
- **目的**: ルートノードの追加が正常に動作することを確認
- **手順**:
  1. 「+ ルート追加」ボタンをクリック
  2. タイトルプロンプトに「テストノード」を入力
  3. 作成者プロンプトに「TestUser」を入力
- **期待結果**:
  - ツリーに「テストノード」が表示される
  - 右ペインでタイトルが「テストノード」、作成者が「TestUser」と表示される

#### TC-FUNC-002: ノード編集機能
- **目的**: ノードの編集が正常に動作することを確認
- **手順**:
  1. ノード「編集テスト」を作成
  2. ノードを選択
  3. タイトルを「更新タイトル」に変更
  4. 内容を「更新内容」に変更
  5. 保存ボタンをクリック
- **期待結果**:
  - ツリーに「更新タイトル」が表示される
  - 右ペインでタイトルが「更新タイトル」と表示される

#### TC-FUNC-003: ノード削除機能
- **目的**: ノードの削除が正常に動作することを確認
- **手順**:
  1. ノード「削除テスト」を作成
  2. ノードを選択
  3. 削除ボタンをクリック
  4. 確認ダイアログでOKをクリック
- **期待結果**:
  - ツリーから「削除テスト」が消える

#### TC-FUNC-004: ツリー表示切替機能
- **目的**: 通常/逆ツリー表示の切替が正常に動作することを確認
- **手順**:
  1. ルートノード「ルート1」を作成
  2. 「逆ツリー」タブをクリック
  3. 「通常」タブをクリック
- **期待結果**:
  - 表示が切り替わる

#### TC-FUNC-005: ツリー展開/折りたたみ
- **目的**: ノードの展開/折りたたみが正常に動作することを確認
- **手順**:
  1. 親ノード「親ノード」を作成
  2. 展開/折りたたみアイコンをクリック
- **期待結果**:
  - ノードが展開/折りたたみされる

#### TC-FUNC-006: 検索機能
- **目的**: 検索機能が正常に動作することを確認
- **手順**:
  1. ノード「検索テストノード」を作成
  2. 検索ボックスに「検索テスト」を入力
  3. クリアボタンをクリック
- **期待結果**:
  - 検索結果が表示される
  - クリア後、検索結果が非表示になる

#### TC-FUNC-007: キーボードナビゲーション
- **目的**: キーボード操作が正常に動作することを確認
- **手順**:
  1. ノード「ノード1」と「ノード2」を作成
  2. 「ノード1」を選択
  3. 下矢印キーを押下
  4. 上矢印キーを押下
- **期待結果**:
  - キーボード操作でノード選択が変わる

#### TC-FUNC-008: コピー&ペースト機能
- **目的**: ノードのコピー&ペーストが正常に動作することを確認
- **手順**:
  1. ノード「コピー元」を作成
  2. ノード「ペースト先」を作成
  3. 「コピー元」を選択
  4. Ctrl+C（Cmd+C）を押下
  5. 「ペースト先」を選択
  6. Ctrl+V（Cmd+V）を押下
- **期待結果**:
  - トースト「ノードをコピーしました」が表示される
  - トースト「親子関係を追加しました」が表示される
  - 「ペースト先」の下に「コピー元」が子として表示される
  - 「ペースト先」が展開される

#### TC-FUNC-009: コピー&ペースト（循環参照）
- **目的**: 循環参照を防止できることを確認
- **手順**:
  1. ノード「親」を作成
  2. 「親」の子として「子」を作成
  3. 「親」を選択してCtrl+C
  4. 「子」を選択してCtrl+V
- **期待結果**:
  - トースト「循環参照です。この操作はできません。」が表示される
  - 親子関係が追加されない

#### TC-FUNC-010: 親ノード表示（単一の親）
- **目的**: 単一の親を持つノードで親が正しく表示されることを確認
- **手順**:
  1. ノード「親A」を作成
  2. 「親A」の子として「子X」を作成
  3. 「子X」を選択
- **期待結果**:
  - 右ペインに親ノード「親A」が表示される
  - 削除ボタン（×）が表示される

#### TC-FUNC-011: 親ノード表示（複数の親）
- **目的**: 複数の親を持つノードで全ての親が表示されることを確認
- **手順**:
  1. ノード「親A」「親B」「子X」を作成
  2. 「子X」を「親A」の子として追加（Ctrl+C/V）
  3. 「子X」を「親B」の子として追加（Ctrl+C/V）
  4. 「子X」を選択
- **期待結果**:
  - 右ペインに親ノード「親A」と「親B」が表示される
  - 各親に削除ボタン（×）が表示される

#### TC-FUNC-012: 親削除機能
- **目的**: 親子関係の削除が正常に動作することを確認
- **手順**:
  1. ノード「親A」「親B」「子X」を作成し、「子X」を両親の子として追加
  2. 「子X」を選択
  3. 「親A」の削除ボタン（×）をクリック
- **期待結果**:
  - 親ノードリストから「親A」が消える
  - 「親B」は残る
  - ツリー表示が更新され、「親A」の下から「子X」が消える

#### TC-FUNC-013: 最後の親削除（ルート化）
- **目的**: 最後の親を削除するとルートノードになることを確認
- **手順**:
  1. ノード「親A」「子X」を作成し、「子X」を「親A」の子として追加
  2. 「子X」を選択
  3. 「親A」の削除ボタン（×）をクリック
- **期待結果**:
  - 親ノード表示エリアが非表示になる
  - ツリー表示が更新され、「子X」がルートレベルに表示される

## 今後の拡張予定

- エクスポート/インポート機能
- 複数ユーザー対応（認証）
- リアルタイム同期
- マークダウンエディタ統合
- タグ機能
- Undo/Redo 機能