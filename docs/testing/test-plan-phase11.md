# Phase 11: プロフィール管理 E2Eテスト計画

## 概要

Phase 11 で実装したプロフィール管理機能の包括的なテストを実施します。プロフィール情報の取得、更新、バリデーション、UI動作、および統合を検証します。

**テスト対象:**
- プロフィール情報の取得
- 表示名の更新
- バリデーション（空チェック、長さ制限、型チェック）
- プロフィールページUI
- 他画面との統合

**テスト方法:** Playwright による E2E テスト

---

## テストケース一覧

### 1. プロフィール情報取得テスト (2 テストケース)

#### TC-PROF-001: プロフィール情報を取得できる
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. GET /api/profile を呼び出し

**期待結果:**
- 200 OK レスポンス
- プロフィールデータが返される
  - id: 1
  - email: test-user-1@example.com
  - display_name: Test User 1
  - oauth_provider: test

---

#### TC-PROF-002: 未認証ユーザーはプロフィールを取得できない
**前提条件:**
- Cookie がクリアされている（未認証状態）

**テスト手順:**
1. Cookie をクリア
2. GET /api/profile を呼び出し

**期待結果:**
- 401 Unauthorized レスポンス

---

### 2. プロフィール更新テスト (4 テストケース)

#### TC-UPD-001: 表示名を更新できる
**前提条件:**
- User 1 がログイン済み
- 現在の表示名: Test User 1

**テスト手順:**
1. User 1 としてログイン
2. GET /api/profile で現在の表示名を確認
3. PUT /api/profile で表示名を 'Updated Name' に更新
4. GET /api/profile で更新を確認

**期待結果:**
- PUT レスポンスが 200 OK
- 新しい表示名が 'Updated Name' になる
- GET でも新しい表示名が返される

---

#### TC-UPD-002: 日本語の表示名を更新できる
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. PUT /api/profile で表示名を '山田 太郎' に更新

**期待結果:**
- 200 OK レスポンス
- 表示名が '山田 太郎' に更新される

---

#### TC-UPD-003: 前後の空白はトリムされる
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. PUT /api/profile で表示名を '  Trimmed Name  ' に更新

**期待結果:**
- 200 OK レスポンス
- 表示名が 'Trimmed Name'（前後の空白が削除）

---

#### TC-UPD-004: 未認証ユーザーは更新できない
**前提条件:**
- Cookie がクリアされている（未認証状態）

**テスト手順:**
1. Cookie をクリア
2. PUT /api/profile で表示名更新を試行

**期待結果:**
- 401 Unauthorized レスポンス

---

### 3. バリデーションテスト (5 テストケース)

#### TC-VAL-001: 空の表示名は拒否される
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. PUT /api/profile で空文字列を送信

**期待結果:**
- 400 Bad Request レスポンス
- エラーメッセージに 'cannot be empty' が含まれる

---

#### TC-VAL-002: 空白のみの表示名は拒否される
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. PUT /api/profile で '   ' (空白のみ) を送信

**期待結果:**
- 400 Bad Request レスポンス
- エラーメッセージに 'cannot be empty' が含まれる

---

#### TC-VAL-003: 101文字以上の表示名は拒否される
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. PUT /api/profile で 101文字の文字列を送信

**期待結果:**
- 400 Bad Request レスポンス
- エラーメッセージに '100 characters' が含まれる

---

#### TC-VAL-004: 100文字ちょうどの表示名は許可される
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. PUT /api/profile で 100文字の文字列を送信

**期待結果:**
- 200 OK レスポンス
- 表示名が100文字の文字列に更新される

---

#### TC-VAL-005: 無効な型の表示名は拒否される
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. PUT /api/profile で数値 123 を送信

**期待結果:**
- 400 Bad Request レスポンス
- エラーメッセージに 'must be a string' が含まれる

---

### 4. プロフィールページUIテスト (7 テストケース)

#### TC-UI-001: プロフィールページが表示される
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. /profile.html に移動
3. #profile-container が表示されるまで待機

**期待結果:**
- ページタイトルに 'プロフィール設定' が表示される
- メールアドレス入力欄に test-user-1@example.com が入力済み
- 表示名入力欄に 'Test User 1' が入力済み

---

#### TC-UI-002: 表示名をUIから更新できる
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. /profile.html に移動
3. 表示名を 'UI Updated Name' に変更
4. 保存ボタンをクリック
5. 成功メッセージの表示を待機
6. API で更新を確認

**期待結果:**
- 成功メッセージが表示される
- GET /api/profile で 'UI Updated Name' が返される

---

#### TC-UI-003: メールアドレスは読み取り専用
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. /profile.html に移動
3. メールアドレス入力欄の状態を確認

**期待結果:**
- メールアドレス入力欄が disabled 状態

---

#### TC-UI-004: 空の表示名でエラーメッセージが表示される
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. /profile.html に移動
3. 表示名をクリアして空にする
4. 保存ボタンをクリック
5. エラーメッセージの表示を待機

**期待結果:**
- エラーメッセージが表示される (.show クラスが追加される)
- エラーテキストに '表示名を入力してください' が含まれる

---

#### TC-UI-005: キャンセルボタンでマイページに戻る
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. /profile.html に移動
3. キャンセルボタンをクリック

**期待結果:**
- /my-page.html に遷移する

---

#### TC-UI-006: ヘッダーのマイページリンクが動作する
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. /profile.html に移動
3. ヘッダーの「マイページに戻る」リンクをクリック

**期待結果:**
- /my-page.html に遷移する

---

#### TC-UI-007: 未認証ユーザーはログインページにリダイレクトされる
**前提条件:**
- Cookie がクリアされている（未認証状態）

**テスト手順:**
1. Cookie をクリア
2. /profile.html に移動

**期待結果:**
- /login.html に自動リダイレクトされる

---

### 5. 統合テスト (2 テストケース)

#### TC-INT-001: プロフィール更新が他の画面に反映される
**前提条件:**
- User 1 がログイン済み

**テスト手順:**
1. User 1 としてログイン
2. PUT /api/profile で表示名を 'Integration Test Name' に更新
3. /my-page.html に移動
4. #user-name 要素を確認

**期待結果:**
- マイページの #user-name に 'Integration Test Name' が表示される

---

#### TC-INT-002: 複数ユーザーのプロフィールは独立している
**前提条件:**
- User 1 と User 2 が登録済み

**テスト手順:**
1. User 1 としてログイン
2. PUT /api/profile で表示名を 'User 1 Name' に更新
3. User 2 としてログイン
4. PUT /api/profile で表示名を 'User 2 Name' に更新
5. User 1 としてログイン
6. GET /api/profile で User 1 のプロフィールを確認
7. User 2 としてログイン
8. GET /api/profile で User 2 のプロフィールを確認

**期待結果:**
- User 1 の表示名は 'User 1 Name' のまま
- User 2 の表示名は 'User 2 Name'
- 互いに影響を受けない

---

## テスト環境

### 前提条件
- Playwright がインストールされている
- 開発サーバーが起動している（npm run dev:sandbox）
- テスト用データベースがクリーンな状態

### テストデータ
- User 1: test-user-1@example.com (Test User 1)
- User 2: test-user-2@example.com (Test User 2)

### 実行コマンド
```bash
npx playwright test tests/multi-user-phase11.spec.js
```

---

## 注意事項

- 各テスト間でデータベースをクリアし、テストの独立性を保証
- プロフィール更新時、前後の空白は自動的にトリムされる
- 表示名の最大長は100文字
- メールアドレスは読み取り専用（変更不可）
- プロフィール更新後、他画面（マイページ等）にも即座に反映される

---

## 期待される結果

すべてのテストケース（20 テスト）が成功し、プロフィール管理機能が正しく動作することを確認します。

**成功基準:**
- プロフィール情報取得: 2/2 成功
- プロフィール更新: 4/4 成功
- バリデーション: 5/5 成功
- プロフィールページUI: 7/7 成功
- 統合テスト: 2/2 成功
- **合計: 20/20 成功 (100%)**

---

## テスト実行結果

### 実施日: 2026-01-29

**結果サマリー**: ✅ **Phase 11 E2Eテスト完了。20テスト成功 (成功率 100%)**

| カテゴリ | 計画 | 成功 | 失敗 | 備考 |
|---------|------|------|------|------|
| プロフィール情報取得 | 2 | 2 | 0 | 全テスト成功 |
| プロフィール更新 | 4 | 4 | 0 | 全テスト成功 |
| バリデーション | 5 | 5 | 0 | 全テスト成功 |
| プロフィールページUI | 7 | 7 | 0 | 全テスト成功 |
| 統合テスト | 2 | 2 | 0 | 全テスト成功 |
| **合計** | **20** | **20** | **0** | **成功率 100%** |

**実行時間**: 約16秒

### テスト詳細

#### ✅ 成功したテスト (20/20)

**プロフィール情報取得 (2/2)**
1. TC-PROF-001: プロフィール情報を取得できる ✓
2. TC-PROF-002: 未認証ユーザーはプロフィールを取得できない ✓

**プロフィール更新 (4/4)**
3. TC-UPD-001: 表示名を更新できる ✓
4. TC-UPD-002: 日本語の表示名を更新できる ✓
5. TC-UPD-003: 前後の空白はトリムされる ✓
6. TC-UPD-004: 未認証ユーザーは更新できない ✓

**バリデーション (5/5)**
7. TC-VAL-001: 空の表示名は拒否される ✓
8. TC-VAL-002: 空白のみの表示名は拒否される ✓
9. TC-VAL-003: 101文字以上の表示名は拒否される ✓
10. TC-VAL-004: 100文字ちょうどの表示名は許可される ✓
11. TC-VAL-005: 無効な型の表示名は拒否される ✓

**プロフィールページUI (7/7)**
12. TC-UI-001: プロフィールページが表示される ✓
13. TC-UI-002: 表示名をUIから更新できる ✓
14. TC-UI-003: メールアドレスは読み取り専用 ✓
15. TC-UI-004: 空の表示名でエラーメッセージが表示される ✓
16. TC-UI-005: キャンセルボタンでマイページに戻る ✓
17. TC-UI-006: ヘッダーのマイページリンクが動作する ✓
18. TC-UI-007: 未認証ユーザーはログインページにリダイレクトされる ✓

**統合テスト (2/2)**
19. TC-INT-001: プロフィール更新が他の画面に反映される ✓
20. TC-INT-002: 複数ユーザーのプロフィールは独立している ✓

### 修正した問題

**問題1: oauth_provider が JWT に含まれていない**
- **原因**: JWTPayload インターフェースに oauth_provider フィールドがなかった
- **解決**:
  1. src/utils/jwt.ts の JWTPayload インターフェースに oauth_provider を追加
  2. generateJWT 関数のパラメータに oauth_provider を追加
  3. JWT ペイロード生成時に oauth_provider を含めるように修正

**問題2: profile.html が配信されない**
- **原因**: profile.html を配信するルートが設定されていなかった
- **解決**: src/index.tsx に profile.html のルートを追加

**問題3: プロフィール更新が反映されない（stale data）**
- **原因**: GET /api/profile が JWT のデータを返していた（ログイン時のデータで更新されない）
- **解決**: GET /api/profile をデータベースから最新データを取得するように変更

**問題4: カスタムエラーメッセージが表示されない**
- **原因**: input 要素の `required` 属性によりブラウザのデフォルト検証が動作し、JavaScript が実行されなかった
- **解決**: profile.html の display-name input から `required` 属性を削除し、JavaScript のみで検証

**問題5: /auth/me が古いデータを返す**
- **原因**: /auth/me が JWT のキャッシュデータを返していた
- **解決**: /auth/me をデータベースから最新データを取得するように変更

### 結論

**Phase 11 のプロフィール管理機能は完全に動作している:**

✅ **動作確認済みの機能 (100% テスト成功):**
- プロフィール情報の取得（認証済み・未認証）
- 表示名の更新（英語・日本語・空白トリム）
- バリデーション（空チェック・長さ制限・型チェック）
- プロフィールページUI（表示・更新・ナビゲーション）
- 統合（他画面への反映・ユーザー間の独立性）

**Phase 11 は完了しました。マルチユーザー対応の全フェーズ (Phase 4-11) が完了しました。**

---

## 全フェーズ統合テスト結果サマリー

| Phase | 機能 | テスト数 | 成功 | 成功率 |
|-------|------|---------|------|--------|
| Phase 4 | 認証・ツリー・権限 | 15 | 15 | 100% |
| Phase 6 | 楽観的ロック | 9 | 9 | 100% |
| Phase 8 | 招待システム | 17 | 17 | 100% |
| Phase 10 | 通知システム | 9 | 9 | 100% (APIのみ) |
| Phase 11 | プロフィール管理 | 20 | 20 | 100% |
| **合計** | | **70** | **70** | **100%** |

**マルチユーザー対応システム全体の E2E テスト成功率: 100%**
