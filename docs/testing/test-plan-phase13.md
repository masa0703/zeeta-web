# Phase 13: 最終統合テスト・ポリッシュ - テスト計画

```toc
```
## 概要

Phase 13 は、これまでに実装した全機能（Phase 1-12）を統合的にテストし、システム全体の品質を確保する最終フェーズです。

**実施日:** 2026-01-29
**テスト種別:** E2E 統合テスト
**目的:** 複数機能の連携動作確認、エッジケース検証、パフォーマンス検証

---

## テスト範囲

### 対象機能
1. **認証フロー** (Phase 1-3)
   - OAuth ログイン
   - セッション管理
   - ログアウト

2. **ツリー管理** (Phase 2-4)
   - ツリーCRUD
   - 権限管理
   - メンバー管理

3. **ノード操作** (Phase 3-4)
   - ノードCRUD
   - マルチペアレント関係
   - ツリー分離

4. **楽観的ロック** (Phase 6)
   - バージョン管理
   - 競合検出
   - 競合解決

5. **招待システム** (Phase 8)
   - 招待送信
   - 招待受諾
   - メール通知

6. **通知システム** (Phase 10)
   - 通知作成
   - 通知表示
   - 既読管理

7. **プロフィール管理** (Phase 11)
   - プロフィール更新
   - 表示名変更

---

## 統合テストケース

### カテゴリ1: 完全なユーザージャーニー (Full User Journey)

#### TC-JOURNEY-001: 新規ユーザーの完全なワークフロー
**説明:** 新規ユーザーがログインから協働作業まで行う完全なシナリオ

**ステップ:**
1. User1 がログイン
2. User1 がツリー "Collaboration Project" を作成
3. User1 がノード "Parent Node" を作成
4. User1 がノード "Child Node" を作成し、Parent の子として設定
5. User1 が User2 を Editor として招待
6. User2 がログイン
7. User2 が通知を確認（招待通知あり）
8. User2 が招待を受諾
9. User2 がツリーにアクセス
10. User2 がノードを編集
11. User1 が変更を確認

**期待結果:**
- すべてのステップがエラーなく完了
- User2 がツリーメンバーに追加される
- User2 の編集が User1 に反映される

#### TC-JOURNEY-002: 権限段階的昇格シナリオ
**説明:** Viewer → Editor → Owner の権限変更フロー

**ステップ:**
1. User1 がツリー作成（Owner）
2. User1 が User2 を Viewer として招待
3. User2 が招待受諾
4. User2 が編集を試みる（失敗）
5. User1 が User2 を Editor に昇格
6. User2 がノード編集に成功
7. User1 が User3 を Viewer として招待
8. User2 が User3 の招待を確認（Editor は招待可能）
9. User1 が User2 を Owner に昇格
10. User2 がメンバー管理権限を取得

**期待結果:**
- 各権限レベルで適切な操作が可能/不可能
- 権限変更が即座に反映される
- 通知が適切に発行される

---

### カテゴリ2: 複数機能の連携 (Cross-Feature Integration)

#### TC-CROSS-001: 招待 + 通知 + プロフィールの連携
**説明:** 招待システムと通知システム、プロフィール変更が正しく連携する

**ステップ:**
1. User1 がツリー作成
2. User1 がプロフィール名を "Project Manager" に変更
3. User1 が User2 を招待
4. User2 がログイン
5. User2 が通知を確認（送信者名が "Project Manager"）
6. User2 が招待を受諾
7. User2 がメンバー一覧で "Project Manager" を確認

**期待結果:**
- 招待メール・通知に更新後のプロフィール名が表示される
- メンバー一覧に正しいプロフィール名が表示される

#### TC-CROSS-002: 楽観的ロック + 通知の連携
**説明:** 競合発生時に通知が正しく発行される（将来拡張）

**ステップ:**
1. User1 と User2 が同じツリーの Editor
2. 両者が同じノードを同時に読み込み
3. User1 がノードを更新（成功）
4. User2 が同じノードを更新（競合）
5. User2 が競合解決（サーバー版を使用）
6. User1 が通知を確認（将来: "Your node was updated by User2"）

**期待結果:**
- 楽観的ロックが正しく競合を検出
- 競合解決が正常に動作
- （将来）通知が適切に発行される

#### TC-CROSS-003: マルチツリー + マルチユーザーの複雑なシナリオ
**説明:** 複数ツリーと複数ユーザーが混在する環境での動作確認

**ステップ:**
1. User1 が Tree A, Tree B を作成
2. User2 が Tree C を作成
3. User1 が User2 を Tree A の Editor として招待
4. User2 が User1 を Tree C の Viewer として招待
5. 両者が招待を受諾
6. User1 が Tree A でノード作成（成功）
7. User1 が Tree C でノード作成（失敗: Viewer）
8. User2 が Tree A でノード作成（成功）
9. User2 が Tree B にアクセス（失敗: メンバーでない）

**期待結果:**
- ツリーごとに権限が正しく分離される
- クロスツリーのアクセスが適切に制御される
- 共有されたツリーが "Shared with Me" に表示される

---

### カテゴリ3: 同時実行・競合処理 (Concurrent Operations)

#### TC-CONCURRENT-001: 複数ユーザーの同時ノード作成
**説明:** 複数ユーザーが同時にノードを作成しても競合しない

**ステップ:**
1. User1 と User2 が同じツリーの Editor
2. User1 が "Node A" を作成
3. User2 が（ほぼ同時に）"Node B" を作成
4. 両者がノード一覧を再取得

**期待結果:**
- 両方のノードが作成される
- ノード一覧に両方が表示される
- 競合エラーが発生しない

#### TC-CONCURRENT-002: 同時編集での楽観的ロック
**説明:** 同じノードの同時編集で楽観的ロックが正しく動作

**ステップ:**
1. User1 と User2 が同じノード (version=1) を読み込み
2. User1 がタイトルを "Title A" に変更して保存（version=2）
3. User2 がタイトルを "Title B" に変更して保存（競合）
4. User2 が 409 エラーを受信
5. User2 が現在のサーバーデータを確認（"Title A", version=2）
6. User2 が "Title B" で再保存（version=3）

**期待結果:**
- User1 の保存が成功（version=2）
- User2 の最初の保存が 409 で失敗
- User2 がサーバーデータを確認できる
- User2 の再保存が成功（version=3）

#### TC-CONCURRENT-003: 同時メンバー追加
**説明:** 複数の Editor が同時にメンバーを招待

**ステップ:**
1. User1 と User2 が同じツリーの Editor
2. User1 が User3 を Viewer として招待
3. User2 が（ほぼ同時に）User4 を Editor として招待
4. 両招待が成功

**期待結果:**
- 両方の招待が作成される
- 招待一覧に両方が表示される
- メール送信が両方で成功

---

### カテゴリ4: エラーハンドリング・回復 (Error Handling & Recovery)

#### TC-ERROR-001: ネットワークエラー時の挙動
**説明:** API エラー時に適切なエラーメッセージが表示される

**ステップ:**
1. User1 がログイン
2. サーバーを一時停止（シミュレーション）
3. User1 がツリー作成を試みる
4. エラーメッセージが表示される
5. サーバー再開
6. User1 が再試行（成功）

**期待結果:**
- ユーザーフレンドリーなエラーメッセージが表示
- リトライで正常に動作
- データ不整合が発生しない

#### TC-ERROR-002: 無効な招待トークンの処理
**説明:** 期限切れ・無効な招待トークンが適切に処理される

**ステップ:**
1. User1 が User2 を招待
2. 招待の有効期限を過去に設定（手動 DB 操作）
3. User2 が招待リンクをクリック
4. エラーメッセージ "This invitation has expired" が表示
5. User1 が新しい招待を送信
6. User2 が新しい招待を受諾（成功）

**期待結果:**
- 期限切れ招待が拒否される
- 明確なエラーメッセージ
- 新しい招待で再試行可能

#### TC-ERROR-003: 存在しないツリーへのアクセス
**説明:** 削除されたツリーへのアクセスが適切に処理される

**ステップ:**
1. User1 がツリー作成
2. User1 が User2 を Editor として招待
3. User2 が招待受諾
4. User1 がツリーを削除
5. User2 がツリーにアクセスを試みる
6. 404 エラーまたはリダイレクト

**期待結果:**
- 適切なエラーメッセージまたはマイページへリダイレクト
- エラーが明確に説明される
- ユーザーが操作を継続可能

#### TC-ERROR-004: 権限不足での操作
**説明:** Viewer が編集操作を試みた場合の処理

**ステップ:**
1. User1 がツリー作成
2. User1 が User2 を Viewer として招待
3. User2 が招待受諾
4. User2 が API 経由でノード作成を試みる（直接リクエスト）
5. 403 Forbidden エラー

**期待結果:**
- 403 エラーが返却される
- エラーメッセージが明確
- データが不正に作成されない

---

### カテゴリ5: パフォーマンス・スケーラビリティ (Performance & Scalability)

#### TC-PERF-001: 大量ノードの読み込み性能
**説明:** 100+ ノードのツリーでのパフォーマンス

**ステップ:**
1. User1 がツリー作成
2. 100個のノードを作成
3. エディタでツリーを読み込み
4. レスポンス時間を計測

**期待結果:**
- 読み込み時間が 3 秒以内
- UI がフリーズしない
- すべてのノードが表示される

#### TC-PERF-002: 複数メンバーの管理（メール送信含む）
**説明:** 複数メンバーへの招待と実際のメール送信の動作確認

**ステップ:**
1. User1 がツリー作成
2. 3人のユーザーを招待（Gmailエイリアスで実際にメール送信）
   - zeeta0703+test1@gmail.com (viewer)
   - zeeta0703+test2@gmail.com (editor)
   - zeeta0703+test3@gmail.com (editor)
3. メンバー一覧を表示
4. 招待一覧を表示

**期待結果:**
- 招待が正常に作成される
- メールが実際に送信される（Mailgun経由）
- メンバー一覧が 2 秒以内に表示
- 招待一覧が 2 秒以内に表示
- UI が応答性を保つ

#### TC-PERF-003: 複雑なDAG構造のレンダリング
**説明:** 多重親子関係を持つ複雑なグラフのレンダリング

**ステップ:**
1. User1 がツリー作成
2. 20個のノードを作成
3. 各ノードに複数の親を設定（マルチペアレント）
4. エディタでグラフを表示

**期待結果:**
- グラフが正しくレンダリングされる
- レンダリング時間が 2 秒以内
- 循環参照が検出される

---

## テスト実施計画

### Phase 13-A: 統合E2Eテスト作成・実施
**期間:** 2026-01-29
**担当:** Claude AI

**タスク:**
1. [IN_PROGRESS] `tests/multi-user-phase13-integration.spec.js` 作成
   - 完全なユーザージャーニー (3 tests)
   - 複数機能の連携 (3 tests)
   - 同時実行・競合処理 (3 tests)
   - エラーハンドリング (4 tests)
   - パフォーマンス検証 (3 tests)

2. テスト実行・結果記録
3. バグ修正（発見された場合）

**成功基準:**
- 全テストケース (16 tests) が成功
- カバレッジ 80% 以上
- パフォーマンス基準を満たす

### Phase 13-B: UI/UX改善
**期間:** 2026-01-29
**担当:** Claude AI

**タスク:**
1. ローディング状態の追加
   - API リクエスト中のスピナー表示
   - ボタンの無効化
   - プログレスバー

2. エラーメッセージの改善
   - ユーザーフレンドリーなメッセージ
   - エラー詳細の表示
   - リトライボタン

3. 成功フィードバックの追加
   - トースト通知
   - 成功メッセージ
   - アニメーション

### Phase 13-C: パフォーマンス最適化
**期間:** 2026-01-29
**担当:** Claude AI

**タスク:**
1. データベースインデックスの追加
   - `nodes.tree_id` インデックス
   - `tree_members.user_id` インデックス
   - `notifications.user_id` インデックス

2. クエリ最適化
   - N+1 問題の解消
   - JOIN の最適化
   - ページネーションの実装

3. フロントエンド最適化
   - 仮想スクロール
   - レイジーローディング
   - メモ化・キャッシング

### Phase 13-D: 最終リグレッションテスト
**期間:** 2026-01-29
**担当:** Claude AI

**タスク:**
1. 全 Phase のテストを再実行
   - Phase 4: 15/15 tests
   - Phase 6: 9/9 tests
   - Phase 8: 17/17 tests
   - Phase 10: 9/9 tests
   - Phase 11: 20/20 tests
   - Phase 13: 16/16 tests

2. 統合テスト実行
3. 問題があれば修正

**成功基準:**
- 全 86 テスト (70 + 16) が成功
- すべての機能が正常動作

### Phase 13-E: ドキュメント最終更新
**期間:** 2026-01-29
**担当:** Claude AI

**タスク:**
1. README.md の更新
2. API ドキュメントの完成
3. トラブルシューティングガイドの拡充
4. デプロイメントガイドの作成

---

## テスト環境

- **ブラウザ:** Chromium (Playwright)
- **データベース:** SQLite (D1 local mode)
- **サーバー:** Cloudflare Workers (dev mode)
- **Node.js:** v18+
- **Playwright:** 最新版

---

## 期待される成果物

1. **テストコード:**
   - `tests/multi-user-phase13-integration.spec.js` (16 tests)

2. **テストレポート:**
   - `docs/test-plan-phase13.md` (このドキュメント)
   - 実行結果の記録

3. **コード改善:**
   - ローディング UI の追加
   - エラーハンドリングの改善
   - パフォーマンス最適化

4. **ドキュメント:**
   - 最終更新された README.md
   - API ドキュメント
   - デプロイメントガイド

---

## リスクと対策

### リスク1: テストの複雑性
- **リスク:** 統合テストが複雑で、デバッグが困難
- **対策:** テストを小さな単位に分割、詳細なログ出力

### リスク2: タイミング問題
- **リスク:** 非同期処理のタイミングでテストが不安定
- **対策:** 適切な待機処理、リトライロジック

### リスク3: パフォーマンス問題
- **リスク:** 大量データで性能低下
- **対策:** インデックス追加、クエリ最適化、ページネーション

---

## まとめ

Phase 13 は、これまでの全実装を統合的にテストし、システムの品質を最終確認するフェーズです。

**テスト総数:** 16 新規テスト + 70 既存テスト = 86 テスト
**目標:** 100% 成功率
**期間:** 2026-01-29 (1日)

このフェーズの完了により、Zeeta Web のマルチユーザー対応が完成します。
